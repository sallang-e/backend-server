name: ğŸ’‹ ì‚´ë‘ì´ ë°±ì—”ë“œ ë°°í¬ ìë™í™”

env:
  DOCKER_HUB_REPOSITORY: gitchan/sallang-e


on:
  push:
    branches:
      - main

jobs:
  backend-docker-build-and-push:
    runs-on: ubuntu-latest
  
  steps:
    - name: âœ¨ Checkout repository
      uses: actions/checkout@v3
      with:
        submodules: true
	token: ${{ secrets.SUBMODULE_TOKEN }}

  - name: âœ¨ JDK 17 ì„¤ì •
    uses: actions/setup-java@v3
    with:
      java-version: '17'
      distribution: 'temurin'

  - name: âœ¨ Gradle Caching
    uses: actions/cache@v3
    with:
      path: |
      	~/.gradle/caches
        ~/.gradle/wrapper
      key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
      restore-keys: |
        ${{ runner.os }}-gradle-

  - name: âœ¨ Gradlew ê¶Œí•œ ì„¤ì •
    run: chmod +x ./gradlew

  - name: âœ¨ Jar íŒŒì¼ ë¹Œë“œ
    run: ./gradlew bootJar

  - name: âœ¨ DockerHubì— ë¡œê·¸ì¸
    uses: docker/login-action@v2
    with:
      username: ${{ secrets.DOCKER_HUB_USERNAME }}
      password: ${{ secrets.DOCKER_HUB_PASSWORD }}

  - name: âœ¨ Docker Image ë¹Œë“œ í›„ DockerHubì— Push
    uses: docker/build-push-action@v4
    with:
      context: ./backend
      file: ./backend/Dockerfile-dev
      push: true
      platforms: linux/arm64
      tags: ${{ env.DOCKER_HUB_REPOSITORY }}:latest
	  
  backend-docker-pull-and-run:
    runs-on: [self-hosted, main]
    if: ${{ needs.backend-docker-build-and-push.result == 'success' }}
    needs: [ backend-docker-build-and-push ]
    steps:
      - name: âœ¨ ë°°í¬ ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰
        run: |
	  sh /home/ubuntu/deploy.sh
